name: Setup Desktop with RustDesk

on:
  workflow_dispatch:  # 手動トリガーで実行

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update system and install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common curl wget gnupg

    - name: Install XFCE desktop environment
      run: |
        # XFCE と軽量 VNC サーバーをインストール（デスクトップ GUI 構築）
        sudo apt-add-repository universe
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-goodies xorg-dbgsym dbus-x11 x11vnc xvfb

    - name: Install RustDesk
      run: |
        # 最新 deb パッケージをダウンロード（2025/11/27 時点: v1.2.6 相当、必要に応じてリリースページ確認）
        wget https://github.com/rustdesk/rustdesk/releases/download/1.2.6/rustdesk-1.2.6-x86_64.deb
        sudo apt-get install -fy ./rustdesk-1.2.6-x86_64.deb
        rm rustdesk-1.2.6-x86_64.deb

    - name: Configure RustDesk as service
      run: |
        # RustDesk を systemd サービスとしてインストール（ヘッドレス起動）
        sudo rustdesk --install-service
        # 固定パスワードを設定（Secrets から取得推奨、セキュリティのためランダム生成例）
        echo "${{ secrets.RUSTDESK_PASSWORD || 'RandomPass123!' }}" | sudo rustdesk --password-store

    - name: Start desktop session and RustDesk
      run: |
        # 仮想ディスプレイで XFCE を起動
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 5
        dbus-launch --exit-with-session startxfce4 &
        sleep 10  # デスクトップ起動待機
        # RustDesk サービス起動
        sudo systemctl start rustdeskd
        sleep 5

    - name: Get RustDesk ID and Password
      run: |
        # ID とパスワードを取得してログ出力（Web クライアントで使用）
        ID=$(sudo rustdesk --get-id)
        PASS=$(sudo rustdesk --get-password)
        echo "RustDesk ID: $ID"
        echo "RustDesk Password: $PASS"
        echo "Use these credentials in RustDesk Web Client: https://rustdesk.com/web"
        # 出力例: ID はランダム生成、PASS は設定値

    - name: Optional: Setup self-hosted server (hbbs/hbbr)
      if: false  # デフォルトオフ、必要なら true に
      run: |
        # 自ホストサーバー（オプション: Web コンソール統合）
        sudo apt-get install -y docker.io docker-compose
        sudo systemctl start docker
        # hbbs/hbbr Docker 起動（ポート 21115-21117 開放、Actions では制限あり）
        docker run --name hbbs -p 21115:21115 -p 21116:21116 -dt rustdesk/rustdesk-server hbbs -r 21117:21117
        docker run --name hbbr -p 21117:21117 -dt rustdesk/rustdesk-server hbbr
        # キー生成（/root/.config/rustdesk/id_ed25519.pub を使用）
        sleep 10
        PUB_KEY=$(docker exec hbbs cat /root/.config/rustdesk/id_ed25519.pub | base64)
        echo "Self-hosted Public Key: $PUB_KEY"
        # クライアント再設定: sudo rustdesk --server hbbs.yourdomain.com:21116 --key $PUB_KEY
