name: Setup Desktop with RustDesk (Persistent)

on:
  workflow_dispatch:  # 手動実行推奨（終了まで待機）

jobs:
  setup:
    runs-on: ubuntu-latest  # Ubuntu 24.04
    timeout-minutes: 360  # 最大6時間（Actions 制限）

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update system and install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl unzip xvfb x11vnc dbus-x11 x11-utils tigervnc-standalone-server tigervnc-common openssl socat xfce4 xfce4-goodies xorg  # XFCE + Xorg
        # RustDesk サーバー OSS v1.1.14 deb インストール (hbbs/hbbr を展開)
        wget https://github.com/rustdesk/rustdesk-server/releases/download/1.1.14/rustdesk-server-hbbs_1.1.14_amd64.deb
        sudo dpkg -i rustdesk-server-hbbs_1.1.14_amd64.deb || sudo apt-get install -f -y
        wget https://github.com/rustdesk/rustdesk-server/releases/download/1.1.14/rustdesk-server-hbbr_1.1.14_amd64.deb
        sudo dpkg -i rustdesk-server-hbbr_1.1.14_amd64.deb || sudo apt-get install -f -y
        echo "Server installed (hbbs/hbbr in /usr/bin/)."

    - name: Generate RustDesk key pair (Ed25519)
      run: |
        openssl genpkey -algorithm ed25519 -out id_ed25519
        openssl pkey -in id_ed25519 -pubout -out id_ed25519.pub
        sudo mkdir -p /opt/rustdesk
        sudo cp id_ed* /opt/rustdesk/
        RUSTDESK_KEY=$(cat id_ed25519.pub | tr -d '\n')
        echo "RUSTDESK_KEY=$RUSTDESK_KEY" >> $GITHUB_ENV
        echo "Generated Key: $RUSTDESK_KEY"

    - name: Start RustDesk Server (hbbs & hbbr)
      run: |
        # hbbs 起動
        nohup hbbs -k /opt/rustdesk/id_ed25519 -r 127.0.0.1:21117 > hbbs.log 2>&1 &
        sleep 5
        # hbbr 起動
        nohup hbbr -k /opt/rustdesk/id_ed25519 > hbbr.log 2>&1 &
        sleep 5
        tail -n 10 hbbs.log
        tail -n 10 hbbr.log
        echo "Server running on 21115-21119."

    - name: Install RustDesk Client (v1.4.4)
      run: |
        wget https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.deb
        sudo dpkg -i rustdesk-1.4.4-x86_64.deb || sudo apt-get install -f -y
        rustdesk --set-id-server "127.0.0.1:21116" --set-key "$RUSTDESK_KEY" --install-service || true
        rustdesk --get-id || true

    - name: Setup Desktop Environment (XFCE + VNC, Warnings Suppressed)
      run: |
        # 警告抑制 (ヘッドレス)
        export XDG_CURRENT_DESKTOP=""
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > xvfb.log 2>&1 &
        sleep 3
        # VNC パスワード (Secrets 優先、デフォルト password)
        VNC_PASS="${{ secrets.VNC_PASSWORD || 'password' }}"
        mkdir -p ~/.vnc
        echo "$VNC_PASS" | x11vnc -storepasswd - -usepw > /dev/null
        nohup x11vnc -display :99 -forever -shared -rfbauth ~/.vnc/passwd -rfbport 5900 > vnc.log 2>&1 &
        sleep 5
        # XFCE 初期化 (power-manager 無効化で警告抑制)
        export DISPLAY=:99
        xsetroot -solid lightblue
        xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/enabled -s false || true
        nohup startxfce4 --daemon > xfce.log 2>&1 &
        sleep 10
        echo "Desktop ready. VNC: localhost:5900 (password: $VNC_PASS). ID: $(rustdesk --get-id || echo 'N/A')"

    - name: Expose Ports with ngrok (Auto Tunnel)
      uses: apogiatzis/ngrok-tunneling-action@v1  # TCP トンネル
      with:
        timeout: 359m  # ほぼ最大（終了前）
        ports: "21115,21116,21117,21118,21119,5900"  # RustDesk + VNC
      env:
        NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

    - name: Output Access Info (Use ngrok URLs)
      run: |
        # ngrok URL 取得 (アクション出力から、ログで確認)
        echo "=== ACCESS INFO (Keep this window open until manual cancel) ==="
        echo "RustDesk Key: $RUSTDESK_KEY"
        echo "ID: $(rustdesk --get-id || echo 'N/A')"
        echo "Runner IP: $(curl -s ifconfig.me)"
        echo "ngrok URLs (from logs): Use wss://*.ngrok.io:<port> for Web Client"
        echo "- hbbs (ID Server): tcp://0.tcp.ngrok.io:21116"
        echo "- hbbr (Relay): tcp://0.tcp.ngrok.io:21117"
        echo "- WebSocket hbbs: wss://*.ngrok.io:21118"
        echo "- WebSocket hbbr: wss://*.ngrok.io:21119"
        echo "- VNC: vncviewer *.ngrok.io:5900 (password: $VNC_PASS)"
        echo "Web Client Config: ID Server = 0.tcp.ngrok.io:21116, Key = $RUSTDESK_KEY"
        echo "Build Web: https://github.com/rustdesk/rustdesk/tree/master/web"
        echo "=== Session active (will auto-end in ~6h) ==="

    - name: Keep Alive (Persistent Loop)
      run: |
        echo "Session kept alive... (Manual cancel recommended)"
        while true; do
          echo "$(date): Session active. Connect now!"
          # ステータス確認
          netstat -tuln | grep 211 || true
          netstat -tuln | grep 5900 || true
          ps aux | grep -E "(hbbs|hbbr|x11vnc|startxfce4)" | grep -v grep || true
          sleep 60  # 1分ごとログ（Actions 制限回避）
        done

    - name: Cleanup (On Cancel/Timeout)
      if: always()
      run: |
        echo "Stopping services..."
        sudo pkill -f hbbs || true
        sudo pkill -f hbbr || true
        sudo pkill -f x11vnc || true
        sudo pkill -f Xvfb || true
        sudo pkill -f rustdesk || true
        sudo pkill -f startxfce4 || true
        sudo pkill -f xfce4 || true
        sudo pkill -f socat || true
        echo "Cleanup done. Session ended."
