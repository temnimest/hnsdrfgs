name: Web Desktop (noVNC + Cloudflare Tunnel + RustDesk)
on:
  workflow_dispatch:  # 手動実行専用

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 最大4時間

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 基本パッケージインストール
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver novnc websockify nginx wget curl unzip openssl

      # 2. RustDesk Server（最新構造に完全対応）
      - name: Install RustDesk Server (hbbs & hbbr)
        run: |
          wget https://github.com/rustdesk/rustdesk-server/releases/latest/download/rustdesk-server-linux-amd64.zip
          unzip rustdesk-server-linux-amd64.zip

          # 新構造（amd64/）にも旧構造にも対応（findで確実に拾う）
          sudo find . -type f -name "hbbs" -exec mv {} /usr/local/bin/hbbs \;
          sudo find . -type f -name "hbbr" -exec mv {} /usr/local/bin/hbbr \;

          # バイナリ確認（デバッグ用）
          which hbbs || (echo "hbbs not found!" && exit 1)
          which hbbr || (echo "hbbr not found!" && exit 1)

          # クリーンアップ
          rm -rf amd64 rustdesk-server-linux-amd64 rustdesk-server-linux-amd64.zip

          # 必要ディレクトリ作成（権限設定）
          sudo mkdir -p /var/lib/rustdesk /var/log/rustdesk
          sudo chmod 755 /var/lib/rustdesk /var/log/rustdesk
          sudo chown -R $USER:$USER /var/log/rustdesk  # ログ書き込み権限

      # 3. cloudflared インストール（Ubuntu 24.04対応）
      - name: Install cloudflared
        run: |
          sudo apt update
          sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt update
          sudo apt install -y cloudflared

      # 4. VNC パスワード設定（固定。必要なら secrets に変更可能）
      - name: Set VNC Password
        run: |
          mkdir -p ~/.vnc
          echo "github123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      # 5. VNC サーバー起動（高画質・低遅延設定）
      - name: Start VNC Server
        run: |
          vncserver :1 -geometry 1600x900 -depth 24 -fps 60 -compresslevel 0 -quality 9 &
          sleep 8

      # 6. RustDesk Server 起動 & ID/Key 取得（フラグ修正 + エラーキャプチャ）
      - name: Start RustDesk Server
        id: rustdesk
        run: |
          # ログディレクトリ確認
          ls -la /var/log/rustdesk || echo "Log dir exists"

          # hbbs 起動（-p フラグ削除: hbbsは固定ポート使用）
          echo "Starting hbbs..."
          nohup sudo hbbs -r /var/lib/rustdesk -k _ > /var/log/rustdesk/hbbs.log 2>&1 &
          HBBS_PID=$!
          sleep 5

          # hbbs エラー確認（stderrキャプチャ）
          if ! sudo ps -p $HBBS_PID > /dev/null; then
            echo "hbbs failed to start! Stderr:"
            sudo cat /var/log/rustdesk/hbbs.log || echo "No log yet"
            exit 1
          fi

          # hbbr 起動（-p フラグ削除）
          echo "Starting hbbr..."
          nohup sudo hbbr -k _ > /var/log/rustdesk/hbbr.log 2>&1 &
          HBBR_PID=$!
          sleep 5

          if ! sudo ps -p $HBBR_PID > /dev/null; then
            echo "hbbr failed to start!"
            exit 1
          fi

          # IDとKeyを確実に取得（最大30秒待機、ログ複数チェック）
          for i in {1..30}; do
            sleep 1
            ID=$(sudo tail -n 100 /var/log/rustdesk/hbbs.log | grep "ID:" | tail -1 | awk '{print $2}' || echo "")
            KEY=$(sudo tail -n 100 /var/log/rustdesk/hbbs.log | grep "Key:" | tail -1 | awk '{print $2}' || echo "")
            if [ -n "$ID" ] && [ -n "$KEY" ]; then
              echo "hbbs log snippet:"
              sudo tail -n 10 /var/log/rustdesk/hbbs.log
              break
            fi
          done

          if [ -z "$ID" ] || [ -z "$KEY" ]; then
            echo "Failed to get RustDesk ID/Key. Full hbbs log:"
            sudo cat /var/log/rustdesk/hbbs.log || echo "Log file still missing - hbbs crashed immediately"
            exit 1
          fi

          echo "RustDesk ID: $ID"
          echo "RustDesk Key: $KEY"
          echo "rustdesk_id=$ID" >> $GITHUB_OUTPUT
          echo "rustdesk_key=$KEY" >> $GITHUB_OUTPUT

      # 7. noVNC 起動（低遅延設定 + HTTPS対応）
      - name: Start noVNC
        run: |
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout ~/self.key -out ~/self.crt -subj "/CN=localhost"

          websockify --web=/usr/share/novnc/ 6080 localhost:5901 \
            --cert=~/self.crt --key=~/self.key \
            --idle-timeout=0 --timeout=0 &
          sleep 5

      # 8. Cloudflare Tunnel 起動（noVNC + RustDesk 全ポート対応）
      - name: Start Cloudflare Tunnel
        id: tunnel
        run: |
          cat > ~/cf-config.yml << EOF
          tunnel: rustdesk-temp-${{ github.run_id }}
          credentials-file: /tmp/cred.json

          ingress:
            - hostname: novnc-${{ github.run_id }}.trycloudflare.com
              service: https://localhost:6080
              originRequest:
                noTLSVerify: true
            - hostname: rustdesk-${{ github.run_id }}.trycloudflare.com
              service: tcp://localhost:21115
            - hostname: relay-${{ github.run_id }}.trycloudflare.com
              service: tcp://localhost:21117
            - service: http_status:404
          EOF

          nohup cloudflared tunnel run --config ~/cf-config.yml > tunnel.log 2>&1 &

          echo "Waiting for tunnel to be ready..."
          for i in {1..60}; do
            sleep 3
            URL=$(grep -o 'https://novnc-.*\.trycloudflare\.com' tunnel.log | head -1)
            [ -n "$URL" ] && break
          done

          if [ -z "$URL" ]; then
            echo "Tunnel URL not found!"
            cat tunnel.log
            exit 1
          fi

          echo "=== DESKTOP READY ==="
          echo "noVNC URL → $URL"
          echo "VNC Password → github123"
          echo "RustDesk ID → ${{ steps.rustdesk.outputs.rustdesk_id }}"
          echo "RustDesk Key → ${{ steps.rustdesk.outputs.rustdesk_key }}"
          echo "RustDesk Connect → rustdesk://${{ steps.rustdesk.outputs.rustdesk_id }}@rustdesk-${{ github.run_id }}.trycloudflare.com?key=${{ steps.rustdesk.outputs.rustdesk_key }}"

          echo "tunnel_url=$URL" >> $GITHUB_OUTPUT

      # 9. 最終出力 & 4時間キープ
      - name: Final Info & Keep Alive
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "    noVNC（ブラウザで即接続）"
          echo "    ${{ steps.tunnel.outputs.tunnel_url }}"
          echo ""
          echo "    VNC パスワード: github123"
          echo ""
          echo "    RustDesk ID : ${{ steps.rustdesk.outputs.rustdesk_id }}"
          echo "    RustDesk Key: ${{ steps.rustdesk.outputs.rustdesk_key }}"
          echo "    RustDesk接続URL（クライアント用）:"
          echo "    rustdesk://${{ steps.rustdesk.outputs.rustdesk_id }}@rustdesk-${{ github.run_id }}.trycloudflare.com?key=${{ steps.rustdesk.outputs.rustdesk_key }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "このセッションは最大4時間有効です（タイムアウトまで待機中）"
          sleep 14400  # 4時間
