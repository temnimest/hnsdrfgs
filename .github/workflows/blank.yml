name: 'Windows Desktop with RustDesk'

on:
  workflow_dispatch:
    inputs:
      rdp_password:
        description: 'RDPæ¥ç¶šç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (runneradminãƒ¦ãƒ¼ã‚¶ãƒ¼)'
        required: true
        type: string
      rustdesk_password:
        description: 'RustDeskæ¥ç¶šç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'
        required: true
        type: string
      hold_time_minutes:
        description: 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç’°å¢ƒã‚’ä¿æŒã™ã‚‹æ™‚é–“ (åˆ†)'
        required: true
        default: '60'
        type: string

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: '1: RDPã‚’æœ‰åŠ¹åŒ–'
        shell: powershell
        run: |
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¥åŠ›ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
          $rdpPassword = "${{ github.event.inputs.rdp_password }}"
          
          # runneradminãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ 'runner' ã§ã¯ãªã 'runneradmin'
          Write-Host "Setting password for 'runneradmin' user..."
          net user runneradmin $rdpPassword
          
          # ã‚³ãƒãƒ³ãƒ‰ãŒæˆåŠŸã—ãŸã‹ç¢ºèª
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to set password for runneradmin user."
            exit 1
          }
          
          # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’å¤‰æ›´ã—ã¦RDPã‚’æœ‰åŠ¹åŒ–
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          
          # ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§RDPãƒãƒ¼ãƒˆã‚’è¨±å¯
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ãªã„ã‚ˆã†ã«ãƒã‚¹ã‚¯
          Write-Output "::add-mask::$rdpPassword"
          Write-Host "RDP has been enabled for user 'runneradmin'."

      - name: '2: RustDeskã®æœ€æ–°ç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹'
        shell: powershell
        run: |
          # GitHub APIã‚’ä½¿ã£ã¦æœ€æ–°ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          $releaseInfo = Invoke-RestMethod -Uri "https://api.github.com/repos/rustdesk/rustdesk/releases/latest"
          $rustdeskAsset = $releaseInfo.assets | Where-Object { $_.name -like "*-x86_64-pc-windows-msvc.zip" }
          
          if (-not $rustdeskAsset) {
            Write-Error "Could not find RustDesk portable asset for Windows x64."
            exit 1
          }
          
          $rustdeskUrl = $rustdeskAsset.browser_download_url
          $outputPath = "rustdesk.zip"
          
          Write-Host "Downloading RustDesk from: $rustdeskUrl"
          Invoke-WebRequest -Uri $rustdeskUrl -OutFile $outputPath
          Expand-Archive -Path $outputPath -DestinationPath .\rustdesk
          Write-Host "RustDesk downloaded and extracted."

      - name: '3: RustDeskã‚’èµ·å‹•ã—ã¦æ¥ç¶šIDã‚’å–å¾—'
        shell: powershell
        run: |
          $rustdeskPassword = "${{ github.event.inputs.rustdesk_password }}"
          
          # RustDeskã‚’ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
          Start-Process -FilePath ".\rustdesk\rustdesk.exe" -ArgumentList "--password", $rustdeskPassword
          
          # RustDeskãŒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã¾ã§å°‘ã—å¾…æ©Ÿ
          Start-Sleep -Seconds 15 # å¾…æ©Ÿæ™‚é–“ã‚’å°‘ã—å¢—ã‚„ã™
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ¥ç¶šIDã‚’èª­ã¿è¾¼ã‚€
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€: %APPDATA%\RustDesk\config\RustDesk.toml
          $configPath = "$env:APPDATA\Rustdesk\config\RustDesk.toml"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºå®Ÿã«ç”Ÿæˆã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿï¼ˆãƒ«ãƒ¼ãƒ—ã§ç¢ºèªï¼‰
          $timeout = 60 # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·
          $timer = 0
          while (-not (Test-Path $configPath) -and $timer -lt $timeout) {
            Start-Sleep -Seconds 2
            $timer++
          }

          if (Test-Path $configPath) {
            $configContent = Get-Content $configPath
            # æ­£è¦è¡¨ç¾ã§IDã‚’æŠ½å‡º
            if ($configContent -match 'id\s*=\s*["\']?(\d+)["\']?') {
              $rustdeskId = $matches[1]
              Write-Output "rustdesk_id=$rustdeskId" >> $env:GITHUB_ENV
              Write-Host "RustDesk ID: $rustdeskId"
            } else {
              Write-Error "Could not find RustDesk ID in config file at $configPath."
              exit 1
            }
          } else {
            Write-Error "RustDesk config file not found after waiting for $timeout seconds."
            exit 1
          }
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¹ã‚¯
          Write-Output "::add-mask::$rustdeskPassword"
          Write-Host "RustDesk started with password."

      - name: '4: æ¥ç¶šæƒ…å ±ã‚’ã‚µãƒãƒªãƒ¼ã«è¡¨ç¤º'
        shell: powershell
        run: |
          # GitHubã®UIã§è¦‹ã‚„ã™ã„ã‚ˆã†ã«ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          $summary = @"
          # ğŸ–¥ï¸ Remote Desktop Connection Details
          
          ã“ã®ä»®æƒ³ãƒã‚·ãƒ³ã¯ã€æŒ‡å®šã•ã‚ŒãŸæ™‚é–“ã ã‘ä¿æŒã•ã‚Œã¾ã™ã€‚

          ## ğŸ“¡ RustDesk (æ¨å¥¨)
          ã“ã‚ŒãŒWebçµŒç”±ã§æ¥ç¶šã™ã‚‹ãŸã‚ã®ä¸»è¦ãªæ–¹æ³•ã§ã™ã€‚

          - **RustDesk ID:** `${{ env.rustdesk_id }}`
          - **Password:** `${{ github.event.inputs.rustdesk_password }}`
          
          **æ¥ç¶šæ‰‹é †:**
          1. ãŠä½¿ã„ã®PCã« [RustDeskã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ](https://rustdesk.com/) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
          2. RustDeskã‚’èµ·å‹•ã—ã€ä¸Šè¨˜ã®ã€ŒRustDesk IDã€ã‚’å…¥åŠ›ã—ã¦æ¥ç¶šã—ã¾ã™ã€‚
          3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãŒæ±‚ã‚ã‚‰ã‚ŒãŸã‚‰ã€ä¸Šè¨˜ã®ã€ŒPasswordã€ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

          ---

          ## ğŸ–¥ï¸ RDP (å‚è€ƒæƒ…å ±)
          **æ³¨æ„:** GitHub Actionsã®Runnerã¯ä¸€èˆ¬çš„ã«å¤–éƒ¨ã‹ã‚‰ã®ç›´æ¥RDPæ¥ç¶šã‚’è¨±å¯ã—ã¦ã„ã¾ã›ã‚“ã€‚ã“ã®æƒ…å ±ã¯ã€åŒã˜ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆãªã©ã«é™ã‚‰ã‚Œã¾ã™ã€‚é€šå¸¸ã¯RustDeskã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚

          - **Computer Name (Host):** `localhost` (Runnerå†…ã§ã®ã¿æœ‰åŠ¹)
          - **Username:** `runneradmin`
          - **Password:** `${{ github.event.inputs.rdp_password }}`
          "@
          
          # ã‚µãƒãƒªãƒ¼ã«å‡ºåŠ›
          echo $summary >> $env:GITHUB_STEP_SUMMARY

      - name: '5: æŒ‡å®šæ™‚é–“ã€ã‚¸ãƒ§ãƒ–ã‚’ä¿æŒ'
        shell: powershell
        run: |
          $holdMinutes = [int]"${{ github.event.inputs.hold_time_minutes }}"
          $holdSeconds = $holdMinutes * 60
          Write-Host "Holding the desktop session for $holdMinutes minutes ($holdSeconds seconds)."
          Write-Host "The workflow will automatically end after this time."
          # æŒ‡å®šã•ã‚ŒãŸæ™‚é–“ã ã‘ã‚¹ãƒªãƒ¼ãƒ—ã—ã¦ã‚¸ãƒ§ãƒ–ã‚’ç¶­æŒã™ã‚‹
          Start-Sleep -Seconds $holdSeconds
