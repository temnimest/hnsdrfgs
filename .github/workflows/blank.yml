# .github/workflows/desktop.yml
name: Web Desktop (noVNC + Cloudflare Tunnel)

on:
  workflow_dispatch:  # 手動実行専用

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4時間まで生きる

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies (Desktop + noVNC)
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver novnc websockify nginx

      - name: Install cloudflared (Ubuntu 24.04対応)
        run: |
          # 依存インストール
          sudo apt update
          sudo apt install -y apt-transport-https ca-certificates gnupg lsb-release
          
          # Cloudflare GPGキー追加
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          
          # リポジトリ追加 (Ubuntu 24.04 = noble)
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg arch=$(dpkg --print-architecture)] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
          
          # 更新してインストール
          sudo apt update
          sudo apt install -y cloudflared

      # VNC パスワード設定（固定値、必要に応じて secrets に変更）
      - name: Set VNC Password
        run: |
          mkdir -p ~/.vnc
          echo "github123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      # VNC サーバー起動（高フレームレート・低遅延設定）
      - name: Start VNC Server (Optimized)
        run: |
          vncserver :1 -geometry 1600x900 -depth 24 -fps 60 -compresslevel 1 -quality 7 &
          sleep 5

      # noVNC 起動（低遅延: WebP無効、Turbo JPEG有効）
      - name: Start noVNC (Low Latency)
        run: |
          # 自署名証明書生成（HTTPS必須）
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ~/self.key -out ~/self.crt -subj "/CN=localhost"
          
          # websockify 起動（タイムアウト無効化）
          websockify --web=/usr/share/novnc/ 6080 localhost:5901 \
            --cert=~/self.crt --key=~/self.key \
            --idle-timeout=0 --timeout=0 --compression=0 &
          sleep 5

      # Cloudflare Tunnel 起動（Quick Tunnel で即時公開）
      - name: Start Cloudflare Tunnel (Quick & Low Latency)
        id: tunnel
        run: |
          # バックグラウンドでトンネル起動
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          # URL 取得（安定するまで待機）
          echo "Waiting for tunnel URL..."
          COUNTER=0
          while [ $COUNTER -lt 60 ]; do
            sleep 2
            URL=$(grep -o 'https://.*\.trycloudflare\.com' tunnel.log | head -n1)
            if [ ! -z "$URL" ]; then
              echo "=== DESKTOP READY ==="
              echo "Open this URL in your browser: $URL"
              echo "VNC Password: github123"
              echo "tunnel_url=$URL" >> $GITHUB_OUTPUT
              break
            fi
            COUNTER=$((COUNTER+1))
          done
          
          if [ -z "$URL" ]; then
            echo "Tunnel URL not found. Check logs."
            cat tunnel.log
            exit 1
          fi

      # セッション保持（4時間）
      - name: Keep Desktop Alive
        run: |
          echo "Desktop is running at: ${{ steps.tunnel.outputs.tunnel_url }}"
          echo "It will stay alive for 4 hours. Use Ctrl+C in browser to disconnect."
          sleep 14400  # 4時間 = 14400秒
