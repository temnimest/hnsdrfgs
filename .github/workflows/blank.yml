# .github/workflows/desktop.yml
name: Web Desktop (noVNC + Cloudflare Tunnel)

on:
  workflow_dispatch:  # 手動実行専用

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 999  # 4時間まで生きる

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Desktop + noVNC + cloudflared
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver novnc websockify nginx cloudflared

      # パスワードは固定でもいいし、secretsにしてもOK（ここでは簡単のため固定）
      - name: Set VNC Password
        run: |
          mkdir -p ~/.vnc
          echo "github123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Start VNC Server (高フレームレート設定)
        run: |
          vncserver :1 -geometry 1600x900 -depth 24 -fps 60 &
          sleep 5

      # noVNC を最適化（WebP無効化で遅延削減、turbo JPEG）
      - name: Start noVNC (低遅延設定)
        run: |
          websockify --web=/usr/share/novnc/ 6080 localhost:5901 \
            --cert=~/self.pem --key=~/self.pem &
          sleep 3

      # Cloudflare Tunnel 起動（最速の方法）
      - name: Cloudflare Tunnel (Quick Tunnel)
        run: |
          # Quick Tunnel（無料・即時公開）
          cloudflared tunnel --url http://localhost:6080 --loglevel info &
          
          # 30秒待ってURLを取得（安定するまで待つ）
          echo "Waiting for tunnel URL..."
          for i in {1..30}; do
            URL=$(cloudflared tunnel route list --output json | jq -r '.[0].connections[0].origin_ip + ":443" | xargs -I {} echo "https://$(cloudflared tunnel --url http://localhost:6080 2>&1 | grep -o 'https://[^ ]*\.trycloudflare\.com')")
            if [[ $URL == https://*.trycloudflare.com ]]; then
              echo "=== YOUR DESKTOP IS READY ==="
              echo "URL: $URL"
              echo "URL=$URL" >> $GITHUB_OUTPUT
              break
            fi
            sleep 5
          done

      # もっと安定させたい場合は、事前にトンネル登録 + トークンを使う（後述）

      - name: Keep alive (4時間)
        run: |
          echo "Desktop will stay alive for 4 hours..."
          sleep 999m
