name: Web Desktop (noVNC + Cloudflare Tunnel + RustDesk)
on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # æœ€å¤§4æ™‚é–“

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver novnc websockify nginx wget curl unzip openssl net-tools  # net-tools for netstat

      # 2. RustDesk Serverï¼ˆæœ€æ–°æ§‹é€ ã«å®Œå…¨å¯¾å¿œï¼‰
      - name: Install RustDesk Server (hbbs & hbbr)
        run: |
          wget https://github.com/rustdesk/rustdesk-server/releases/latest/download/rustdesk-server-linux-amd64.zip
          unzip rustdesk-server-linux-amd64.zip

          # æ–°æ§‹é€ ï¼ˆamd64/ï¼‰ã«ã‚‚æ—§æ§‹é€ ã«ã‚‚å¯¾å¿œï¼ˆfindã§ç¢ºå®Ÿã«æ‹¾ã†ï¼‰
          sudo find . -type f -name "hbbs" -exec mv {} /usr/local/bin/hbbs \;
          sudo find . -type f -name "hbbr" -exec mv {} /usr/local/bin/hbbr \;

          # ãƒã‚¤ãƒŠãƒªç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          which hbbs || (echo "hbbs not found!" && exit 1)
          which hbbr || (echo "hbbr not found!" && exit 1)

          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -rf amd64 rustdesk-server-linux-amd64 rustdesk-server-linux-amd64.zip

          # å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆæ¨©é™è¨­å®šï¼‰
          sudo mkdir -p /var/lib/rustdesk /var/log/rustdesk
          sudo chmod 755 /var/lib/rustdesk /var/log/rustdesk
          sudo chown -R $USER:$USER /var/log/rustdesk  # ãƒ­ã‚°æ›¸ãè¾¼ã¿æ¨©é™

      # 3. cloudflared ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆUbuntu 24.04å¯¾å¿œï¼‰
      - name: Install cloudflared
        run: |
          sudo apt update
          sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt update
          sudo apt install -y cloudflared

      # 4. VNC ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆå›ºå®šã€‚å¿…è¦ãªã‚‰ secrets ã«å¤‰æ›´å¯èƒ½ï¼‰
      - name: Set VNC Password
        run: |
          mkdir -p ~/.vnc
          echo "github123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      # 5. VNC ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆé«˜ç”»è³ªãƒ»ä½é…å»¶è¨­å®šï¼‰
      - name: Start VNC Server
        run: |
          vncserver :1 -geometry 1600x900 -depth 24 -fps 60 -compresslevel 0 -quality 9 &
          sleep 8

      # 6. RustDesk Server èµ·å‹•ï¼ˆãƒ•ãƒ©ã‚°ä¿®æ­£ + ãƒ—ãƒ­ã‚»ã‚¹/ãƒãƒ¼ãƒˆç¢ºèªï¼‰
      - name: Start RustDesk Server
        id: rustdesk
        run: |
          # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
          ls -la /var/log/rustdesk || echo "Log dir exists"

          # hbbs èµ·å‹•ï¼ˆ-k _ å‰Šé™¤: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚­ãƒ¼ç”Ÿæˆï¼‰
          echo "Starting hbbs..."
          nohup sudo hbbs -r /var/lib/rustdesk > /var/log/rustdesk/hbbs.log 2>&1 &
          HBBS_PID=$!
          sleep 10  # ã‚­ãƒ¼ç”Ÿæˆå¾…æ©Ÿ

          # hbbs ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
          if ! sudo ps -p $HBBS_PID > /dev/null; then
            echo "hbbs failed to start! Log:"
            sudo cat /var/log/rustdesk/hbbs.log || echo "No log yet"
            exit 1
          fi

          # ãƒãƒ¼ãƒˆãƒªã‚¹ãƒ‹ãƒ³ã‚°ç¢ºèªï¼ˆhbbsã®21115/21116ï¼‰
          if ! netstat -tuln | grep -q ":21115\|:21116"; then
            echo "hbbs ports not listening!"
            netstat -tuln | grep 211
            exit 1
          fi

          # hbbr èµ·å‹•
          echo "Starting hbbr..."
          nohup sudo hbbr > /var/log/rustdesk/hbbr.log 2>&1 &
          HBBR_PID=$!
          sleep 5

          if ! sudo ps -p $HBBR_PID > /dev/null; then
            echo "hbbr failed to start! Log:"
            sudo cat /var/log/rustdesk/hbbr.log
            exit 1
          fi

          # ã‚­ãƒ¼æŠ½å‡ºï¼ˆIDã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šæ™‚ã«ç”Ÿæˆï¼‰
          sleep 5  # è¿½åŠ å¾…æ©Ÿ
          KEY=$(sudo tail -n 50 /var/log/rustdesk/hbbs.log | grep "Key:" | tail -1 | awk '{print $2}' || echo "")
          if [ -z "$KEY" ]; then
            echo "Failed to get RustDesk Key. Full log:"
            sudo cat /var/log/rustdesk/hbbs.log
            exit 1
          fi

          echo "RustDesk Server started successfully!"
          echo "Generated Key: $KEY"
          echo "Note: ID will be generated when a RustDesk client connects to the server."
          echo "rustdesk_key=$KEY" >> $GITHUB_OUTPUT

          # ãƒ­ã‚°ã‚¹ãƒ‹ãƒšãƒƒãƒˆè¡¨ç¤º
          echo "hbbs log snippet:"
          sudo tail -n 15 /var/log/rustdesk/hbbs.log

      # 7. noVNC èµ·å‹•ï¼ˆä½é…å»¶è¨­å®š + HTTPSå¯¾å¿œï¼‰
      - name: Start noVNC
        run: |
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout ~/self.key -out ~/self.crt -subj "/CN=localhost"

          websockify --web=/usr/share/novnc/ 6080 localhost:5901 \
            --cert=~/self.crt --key=~/self.key \
            --idle-timeout=0 --timeout=0 &
          sleep 5

      # 8. Cloudflare Tunnel èµ·å‹•ï¼ˆnoVNC + RustDesk å…¨ãƒãƒ¼ãƒˆå¯¾å¿œï¼‰
      - name: Start Cloudflare Tunnel
        id: tunnel
        run: |
          cat > ~/cf-config.yml << EOF
          tunnel: rustdesk-temp-${{ github.run_id }}
          credentials-file: /tmp/cred.json

          ingress:
            - hostname: novnc-${{ github.run_id }}.trycloudflare.com
              service: https://localhost:6080
              originRequest:
                noTLSVerify: true
            - hostname: rustdesk-${{ github.run_id }}.trycloudflare.com
              service: tcp://localhost:21115
            - hostname: relay-${{ github.run_id }}.trycloudflare.com
              service: tcp://localhost:21117
            - service: http_status:404
          EOF

          nohup cloudflared tunnel run --config ~/cf-config.yml > tunnel.log 2>&1 &

          echo "Waiting for tunnel to be ready..."
          for i in {1..60}; do
            sleep 3
            URL=$(grep -o 'https://novnc-.*\.trycloudflare\.com' tunnel.log | head -1)
            [ -n "$URL" ] && break
          done

          if [ -z "$URL" ]; then
            echo "Tunnel URL not found!"
            cat tunnel.log
            exit 1
          fi

          echo "=== DESKTOP READY ==="
          echo "noVNC URL â†’ $URL"
          echo "VNC Password â†’ github123"
          echo "RustDesk Key â†’ ${{ steps.rustdesk.outputs.rustdesk_key }}"
          echo "RustDesk Server URL â†’ rustdesk-${{ github.run_id }}.trycloudflare.com:21115"
          echo "RustDesk Connect â†’ Connect via RustDesk client to generate ID"

          echo "tunnel_url=$URL" >> $GITHUB_OUTPUT

      # 9. æœ€çµ‚å‡ºåŠ› & 4æ™‚é–“ã‚­ãƒ¼ãƒ—
      - name: Final Info & Keep Alive
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "    noVNCï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§å³æ¥ç¶šï¼‰"
          echo "    ${{ steps.tunnel.outputs.tunnel_url }}"
          echo ""
          echo "    VNC ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: github123"
          echo ""
          echo "    RustDesk Server Key: ${{ steps.rustdesk.outputs.rustdesk_key }}"
          echo "    RustDesk ã‚µãƒ¼ãƒãƒ¼URL: rustdesk-${{ github.run_id }}.trycloudflare.com:21115"
          echo ""
          echo "    ğŸ“ æ³¨æ„: RustDesk IDã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šæ™‚ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚"
          echo "      1. RustDeskã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•"
          echo "      2. IDå…¥åŠ›æ¬„ã§ã€Œ+ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚µãƒ¼ãƒãƒ¼è¿½åŠ "
          echo "      3. ã‚µãƒ¼ãƒãƒ¼: rustdesk-${{ github.run_id }}.trycloudflare.com:21115"
          echo "      4. ã‚­ãƒ¼: ${{ steps.rustdesk.outputs.rustdesk_key }}"
          echo "      5. æ¥ç¶š â†’ IDãŒè‡ªå‹•ç”Ÿæˆãƒ»è¡¨ç¤ºã•ã‚Œã¾ã™"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æœ€å¤§4æ™‚é–“æœ‰åŠ¹ã§ã™ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§å¾…æ©Ÿä¸­ï¼‰"
          sleep 14400  # 4æ™‚é–“
